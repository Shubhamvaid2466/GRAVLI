<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gravli - Campus Delivery</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-primary: #f3f4f6;
            --bg-secondary: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-muted: #9ca3af;
            --border-color: #e5e7eb;
            --accent-color: #8b5cf6;
            --accent-hover: #7c3aed;
        }

        .dark {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #6b7280;
            --border-color: #374151;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: 0.4s ease;
        }

        /* New Café Cards */
        .cafe-card {
            border-radius: 1rem;
            overflow: hidden;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.12);
            cursor: pointer;
            transition: 0.25s ease;
        }
        .cafe-card:hover {
            transform: scale(1.04);
            box-shadow: 0 12px 24px rgba(0,0,0,0.2);
        }
        .cafe-image {
            width: 100%;
            height: 140px;
            object-fit: cover;
            transition: 0.3s ease;
        }
        .cafe-card:hover .cafe-image {
            transform: scale(1.08);
        }
        .badge {
            font-size: 0.65rem;
            padding: 3px 6px;
            border-radius: 6px;
            font-weight: 700;
        }
        .badge-popular { background: gold; color: #222; }
        .badge-open { background: #22c55e; color: white; }
        .badge-closed { background: #ef4444; color: white; }

        @media (max-width: 640px) {
            .cafe-image { height: 110px; }
        }
    </style>
</head>
<body class="bg-primary text-primary">
<script>
// ============================================================
// 12 CAFES (with images, ratings, open/closed, popular, delivery time)
// ============================================================

const CAFE_LIST = [
    {
        id: "HR1",
        name: "Abhi Canteen",
        image: "https://i.imgur.com/f1ZkQN8.jpeg",
        rating: 4.7,
        popular: true,
        isOpen: true,
        deliveryTime: "5–10 min"
    },
    {
        id: "HR2",
        name: "Campus Café",
        image: "https://i.imgur.com/bq2dV0W.jpeg",
        rating: 4.3,
        popular: false,
        isOpen: false,
        deliveryTime: "Closed"
    },
    {
        id: "HR3",
        name: "Library Snacks",
        image: "https://i.imgur.com/GO9y3Ns.jpeg",
        rating: 4.8,
        popular: true,
        isOpen: true,
        deliveryTime: "8–12 min"
    },
    {
        id: "HR4",
        name: "Main Gate Shop",
        image: "https://i.imgur.com/nZuV51U.jpeg",
        rating: 4.4,
        popular: false,
        isOpen: true,
        deliveryTime: "10–15 min"
    },
    {
        id: "HR5",
        name: "Nescafe Point",
        image: "https://i.imgur.com/94xkW7v.jpeg",
        rating: 4.6,
        popular: true,
        isOpen: true,
        deliveryTime: "5–8 min"
    },
    {
        id: "HR6",
        name: "South Indian Corner",
        image: "https://i.imgur.com/7FsuxjS.jpeg",
        rating: 4.2,
        popular: false,
        isOpen: true,
        deliveryTime: "12–18 min"
    },
    {
        id: "HR7",
        name: "Juice Junction",
        image: "https://i.imgur.com/CHzEYZI.jpeg",
        rating: 4.9,
        popular: true,
        isOpen: true,
        deliveryTime: "3–7 min"
    },
    {
        id: "HR8",
        name: "Amul Parlour",
        image: "https://i.imgur.com/fdzuTtS.jpeg",
        rating: 4.1,
        popular: false,
        isOpen: false,
        deliveryTime: "Closed"
    },
    {
        id: "HR9",
        name: "Hostel Cafe",
        image: "https://i.imgur.com/nCxfKQk.jpeg",
        rating: 4.5,
        popular: true,
        isOpen: true,
        deliveryTime: "7–11 min"
    },
    {
        id: "HR10",
        name: "Biryani Spot",
        image: "https://i.imgur.com/THaQ4PT.jpeg",
        rating: 4.6,
        popular: true,
        isOpen: true,
        deliveryTime: "15–22 min"
    },
    {
        id: "HR11",
        name: "Fast Food Corner",
        image: "https://i.imgur.com/AtG7oF6.jpeg",
        rating: 4.0,
        popular: false,
        isOpen: true,
        deliveryTime: "10–16 min"
    },
    {
        id: "HR12",
        name: "Chai Adda",
        image: "https://i.imgur.com/NgNhE2w.jpeg",
        rating: 4.7,
        popular: true,
        isOpen: true,
        deliveryTime: "5–9 min"
    }
];


// ============================================================
// NEW renderCafes() — uses images, ratings, badges, animations
// ============================================================

function renderCafes() {
    cafeGridContainer.innerHTML = "";

    CAFE_LIST.forEach(cafe => {
        const card = document.createElement("div");
        card.className = "cafe-card";
        card.dataset.cafeId = cafe.id;

        card.innerHTML = `
            <div class="relative">
                <img src="${cafe.image}" alt="${cafe.name}" class="cafe-image">

                <!-- Popular Badge -->
                <div class="absolute top-2 left-2 flex gap-2">
                    ${cafe.popular ? `<span class="badge badge-popular">⭐ Popular</span>` : ""}
                </div>

                <!-- OPEN / CLOSED Badge -->
                <div class="absolute top-2 right-2">
                    <span class="badge ${cafe.isOpen ? 'badge-open' : 'badge-closed'}">
                        ${cafe.isOpen ? 'Open' : 'Closed'}
                    </span>
                </div>

                <!-- Name + Rating Overlay -->
                <div class="absolute bottom-0 w-full px-3 pb-2 pt-10 cafe-overlay">
                    <h3 class="font-bold text-lg">${cafe.name}</h3>
                    <p class="text-sm">⭐ ${cafe.rating}</p>
                </div>
            </div>

            <div class="p-3">
                <p class="text-secondary text-sm font-medium">⏱ ${cafe.deliveryTime}</p>
            </div>
        `;

        cafeGridContainer.appendChild(card);
    });
}

</script>
<script type="module">
/* -----------------------------------------------------------
   FIREBASE IMPORTS
----------------------------------------------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import {
    getAuth,
    onAuthStateChanged,
    GoogleAuthProvider,
    signInWithPopup,
    signOut
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
    getFirestore,
    collection,
    addDoc,
    onSnapshot,
    query,
    doc,
    updateDoc,
    serverTimestamp,
    deleteDoc
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* -----------------------------------------------------------
   FIREBASE CONFIG
----------------------------------------------------------- */
const appId = typeof __app_id !== 'undefined' ? __app_id : "gravli-campus-app";
const firebaseConfig = {
    apiKey: "AIzaSyBnStrl0raNIb9Gr9-TtNzSImwbOQ36l_w",
    authDomain: "linkdash-3865d.firebaseapp.com",
    projectId: "linkdash-3865d",
    storageBucket: "linkdash-3865d.firebasestorage.app",
    messagingSenderId: "337760264309",
    appId: "1:337760264309:web:de20eaa36f7b9de688983c",
    measurementId: "G-RXLFFT5F2K"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

/* -----------------------------------------------------------
   MENU DATA GENERATOR
----------------------------------------------------------- */
function generateMenuItems(cafeId, count = 15) {
    const list = [];
    for (let i = 1; i <= count; i++) {
        list.push({
            id: `${cafeId}-${i}`,
            name: `Item ${i}`,
            price: 80 + i * 5
        });
    }
    return list;
}

const CAFE_DATA = {};
CAFE_LIST.forEach(cafe => {
    CAFE_DATA[cafe.id] = {
        name: cafe.name,
        items: generateMenuItems(cafe.id, 15)
    };
});

/* -----------------------------------------------------------
   GLOBAL STATE
----------------------------------------------------------- */
let currentUser = null;
let userDetails = null;
let unsubscribe = null;
let cart = {};
let currentOpenCafeId = null;

/* -----------------------------------------------------------
   ELEMENTS
----------------------------------------------------------- */
const loginModal = document.getElementById("login-modal");
const googleSignInBtn = document.getElementById("google-signin-btn");
const roleSelectionModal = document.getElementById("role-selection-modal");
const selectStudentBtn = document.getElementById("select-student-btn");
const selectDelivererBtn = document.getElementById("select-deliverer-btn");

const mainHeader = document.getElementById("main-header");
const userInfo = document.getElementById("userInfo");
const userAvatar = document.getElementById("user-avatar");
const logoutBtn = document.getElementById("logout-btn");
const orderHistoryBtn = document.getElementById("order-history-btn");

const studentView = document.getElementById("student-view");
const delivererView = document.getElementById("deliverer-view");
const appContainer = document.getElementById("app");

const cafeGridContainer = document.getElementById("cafe-grid-container");

const menuModal = document.getElementById("menu-modal");
const menuModalContent = document.getElementById("menu-modal-content");
const menuModalTitle = document.getElementById("menu-modal-title");
const menuItemsContainer = document.getElementById("menu-items-container");

const cartButton = document.getElementById("cart-button");
const cartButtonText = document.getElementById("cart-button-text");
const cartModal = document.getElementById("cart-modal");
const cartModalContent = document.getElementById("cart-modal-content");
const cartItemsContainer = document.getElementById("cart-items-container");
const cartCloseBtn = document.getElementById("cart-close-btn");
const cartTotalPrice = document.getElementById("cart-total-price");

const checkoutBtn = document.getElementById("checkout-btn");
const checkoutModal = document.getElementById("checkout-modal");
const checkoutModalContent = document.getElementById("checkout-modal-content");
const checkoutForm = document.getElementById("checkout-form");
const checkoutTotalDisplay = document.getElementById("checkout-total-display");

const loadingModal = document.getElementById("loading-modal");

const historyModal = document.getElementById("history-modal");
const historyModalContent = document.getElementById("history-modal-content");
const historyItemsContainer = document.getElementById("history-items-container");
const historyCloseBtn = document.getElementById("history-close-btn");

const activeOrderBar = document.getElementById("active-order-bar");
const activeOrderBarStatus = document.getElementById("active-order-bar-status");

/* -----------------------------------------------------------
   AUTH STATE
----------------------------------------------------------- */
onAuthStateChanged(auth, user => {
    if (user) {
        currentUser = user;
        userDetails = {
            name: user.displayName,
            uid: user.uid,
            photoURL: user.photoURL
        };

        loginModal.classList.add("hidden");
        roleSelectionModal.classList.remove("hidden");

        userInfo.innerHTML = `<p class="font-semibold">Hello, ${userDetails.name}</p>`;
        if (userDetails.photoURL) {
            userAvatar.src = userDetails.photoURL;
            userAvatar.classList.remove("hidden");
        }

    } else {
        currentUser = null;
        loginModal.classList.remove("hidden");
    }
});

googleSignInBtn.onclick = async () => {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider).catch(() => alert("Sign-in failed"));
};

/* -----------------------------------------------------------
   ROLE SELECTION
----------------------------------------------------------- */
selectStudentBtn.onclick = () => {
    roleSelectionModal.classList.add("hidden");
    appContainer.classList.remove("hidden");
    studentView.classList.remove("hidden");
    delivererView.classList.add("hidden");
    renderCafes();
    fetchAndDisplayRequests();
};

selectDelivererBtn.onclick = () => {
    roleSelectionModal.classList.add("hidden");
    appContainer.classList.remove("hidden");
    studentView.classList.add("hidden");
    delivererView.classList.remove("hidden");
    fetchAndDisplayRequests();
};

/* -----------------------------------------------------------
   MENU MODAL
----------------------------------------------------------- */
function openMenuModal(cafeId) {
    currentOpenCafeId = cafeId;
    const cafe = CAFE_DATA[cafeId];

    menuModalTitle.textContent = cafe.name;
    renderMenu(cafeId);

    menuModal.classList.remove("hidden");
    setTimeout(() => {
        menuModal.classList.remove("opacity-0");
        menuModalContent.classList.remove("scale-95");
    }, 10);
}

function renderMenu(cafeId) {
    const cafe = CAFE_DATA[cafeId];
    menuItemsContainer.innerHTML = "";

    cafe.items.forEach(item => {
        const qty = cart[item.id]?.quantity || 0;

        const row = document.createElement("div");
        row.className = "flex items-center justify-between bg-primary p-3 rounded-lg";
        row.innerHTML = `
            <div>
                <p class="font-semibold">${item.name}</p>
                <p class="text-sm text-secondary">₹${item.price}</p>
            </div>

            <div class="flex items-center gap-2">
                <button data-id="${item.id}" data-change="-1"
                    class="bg-gray-300 dark:bg-gray-600 w-7 h-7 rounded-full font-bold ${qty===0 ? "opacity-40" : ""}">
                    -
                </button>

                <span class="w-6 text-center font-semibold">${qty}</span>

                <button data-id="${item.id}" data-change="1"
                    class="accent w-7 h-7 rounded-full text-white font-bold">
                    +
                </button>
            </div>
        `;

        menuItemsContainer.appendChild(row);
    });
}

/* -----------------------------------------------------------
   CART LOGIC
----------------------------------------------------------- */
function updateCart(itemId, change) {
    const cafe = CAFE_DATA[currentOpenCafeId];
    const item = cafe.items.find(i => i.id === itemId);

    if (!item) return;

    if (!cart[itemId]) {
        cart[itemId] = {
            name: item.name,
            price: item.price,
            quantity: 0,
            cafeId: currentOpenCafeId,
            cafeName: cafe.name
        };
    }

    cart[itemId].quantity += change;

    if (cart[itemId].quantity <= 0) {
        delete cart[itemId];
    }

    renderMenu(currentOpenCafeId);
    updateCartButton();
}

function updateCartButton() {
    const count = Object.values(cart).reduce((a, b) => a + b.quantity, 0);

    if (count > 0) {
        cartButtonText.textContent = `View Cart (${count})`;
        cartButton.classList.remove("hidden");
    } else {
        cartButton.classList.add("hidden");
    }
}

/* -----------------------------------------------------------
   OPENS CART MODAL
----------------------------------------------------------- */
cartButton.onclick = () => openCart();

function openCart() {
    cartItemsContainer.innerHTML = "";
    let total = 0;

    if (Object.keys(cart).length === 0) {
        cartItemsContainer.innerHTML = `<p class="text-secondary text-center">Cart is empty</p>`;
        cartTotalPrice.textContent = "₹0";
    } else {
        for (const id in cart) {
            const item = cart[id];

            const line = document.createElement("div");
            line.className = "flex items-center justify-between";

            line.innerHTML = `
                <div class="flex items-center gap-2">
                    <button data-remove="${id}" class="text-red-500 text-lg">&times;</button>
                    <div>
                        <p class="font-semibold">${item.name} x ${item.quantity}</p>
                        <p class="text-sm text-secondary">${item.cafeName}</p>
                    </div>
                </div>

                <p class="font-semibold">₹${item.price * item.quantity}</p>
            `;

            cartItemsContainer.appendChild(line);
            total += item.price * item.quantity;
        }

        cartTotalPrice.textContent = `₹${total}`;
    }

    cartModal.classList.remove("hidden");
    setTimeout(() => {
        cartModal.classList.remove("opacity-0");
        cartModalContent.classList.remove("scale-95");
    }, 10);
}

/* -----------------------------------------------------------
   REMOVE ITEM IN CART
----------------------------------------------------------- */
cartItemsContainer.onclick = e => {
    const remove = e.target.dataset.remove;
    if (!remove) return;

    delete cart[remove];
    updateCartButton();
    openCart();
};

/* -----------------------------------------------------------
   CHECKOUT
----------------------------------------------------------- */
checkoutBtn.onclick = () => {
    closeCart();
    const total = Object.values(cart).reduce((sum, i) => sum + (i.price * i.quantity), 0);
    const deliveryFee = 50;

    checkoutTotalDisplay.textContent = `₹${total + deliveryFee}`;

    checkoutModal.classList.remove("hidden");
    setTimeout(() => {
        checkoutModal.classList.remove("opacity-0");
        checkoutModalContent.classList.remove("scale-95");
    }, 10);
};

function closeCart() {
    cartModal.classList.add("opacity-0");
    cartModalContent.classList.add("scale-95");
    setTimeout(() => cartModal.classList.add("hidden"), 300);
}

/* -----------------------------------------------------------
   SUBMIT ORDER
----------------------------------------------------------- */
checkoutForm.onsubmit = async e => {
    e.preventDefault();

    const dropoff = document.getElementById("dropoff").value;
    if (!dropoff) return alert("Select dropoff location");

    loadingModal.classList.remove("hidden");

    const items = Object.values(cart);
    const cafeName = items[0].cafeName;

    const itemTotal = items.reduce((sum, i) => sum + (i.price * i.quantity), 0);
    const deliveryFee = 50;

    const request = {
        items,
        itemPrice: itemTotal,
        totalAmount: itemTotal + deliveryFee,
        pickupLocation: cafeName,
        dropoffLocation: dropoff,
        status: "open",
        requesterId: currentUser.uid,
        requesterName: currentUser.displayName,
        requesterPhotoURL: currentUser.photoURL,
        createdAt: serverTimestamp()
    };

    await addDoc(collection(db, `/artifacts/${appId}/public/data/deliveries`), request);

    loadingModal.classList.add("hidden");
    checkoutModal.classList.add("hidden");

    cart = {};
    updateCartButton();
};

/* -----------------------------------------------------------
   FIRESTORE - FETCH REQUESTS
----------------------------------------------------------- */
function fetchAndDisplayRequests() {
    const q = query(collection(db, `/artifacts/${appId}/public/data/deliveries`));

    unsubscribe = onSnapshot(q, snapshot => {
        const list = [];
        snapshot.forEach(doc => {
            list.push({ id: doc.id, ...doc.data() });
        });

        displayRequests(list);
    });
}

/* -----------------------------------------------------------
   DISPLAY REQUESTS
----------------------------------------------------------- */
function displayRequests(requests) {
    const myRequestsList = document.getElementById("my-requests-list");
    const allRequestsListDeliverer = document.getElementById("all-requests-list-deliverer");
    const myCurrentDeliveriesList = document.getElementById("my-current-deliveries-list");

    myRequestsList.innerHTML = "";
    allRequestsListDeliverer.innerHTML = "";
    myCurrentDeliveriesList.innerHTML = "";

    requests.forEach(req => {
        const card = createRequestCard(req);

        if (req.requesterId === currentUser.uid) {
            myRequestsList.appendChild(card);
        }

        if (req.delivererId === currentUser.uid) {
            myCurrentDeliveriesList.appendChild(card);
        }

        if (req.status === "open") {
            allRequestsListDeliverer.appendChild(card);
        }
    });
}

/* -----------------------------------------------------------
   CREATE REQUEST CARD
----------------------------------------------------------- */
function createRequestCard(req) {
    const card = document.createElement("div");
    card.className = "bg-secondary p-4 rounded-lg shadow border border-custom";

    card.innerHTML = `
        <h3 class="font-bold text-accent mb-1">${req.pickupLocation}</h3>
        <p class="text-sm text-secondary mb-2">To: ${req.dropoffLocation}</p>
        <p class="text-sm mb-2 font-medium">Total: ₹${req.totalAmount}</p>
        <p class="text-xs text-muted mb-3">Status: ${req.status}</p>

        ${req.status === "open" && req.requesterId !== currentUser.uid
            ? `<button class="accept-btn w-full bg-green-500 text-white py-2 rounded mt-2" data-id="${req.id}">
                Accept Delivery
              </button>`
            : ""
        }
    `;

    return card;
}

/* -----------------------------------------------------------
   ACCEPT DELIVERY
----------------------------------------------------------- */
document.addEventListener("click", async e => {
    const btn = e.target.closest(".accept-btn");
    if (!btn) return;

    const id = btn.dataset.id;
    await updateDoc(doc(db, `/artifacts/${appId}/public/data/deliveries`, id), {
        status: "in-progress",
        delivererId: currentUser.uid,
        delivererName: currentUser.displayName
    });
});
</script>
