<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gravli - Campus Delivery</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS Variables --- */
        :root {
            --bg-primary: #f3f4f6;
            --bg-secondary: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-muted: #9ca3af;
            --border-color: #e5e7eb;
            --accent-color: #8b5cf6;
            --accent-hover: #7c3aed;
            --success-bg: #22c55e;
            --danger-bg: #ef4444;
            --info-bg: #3b82f6;
            --header-bg-start: #7c3aed;
            --header-bg-end: #4f46e5;
            
            --radius-sm: 0.25rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            
            --container-max-width: 1400px;
        }

        .dark {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #6b7280;
            --border-color: #374151;
        }
        
        /* Reset & Base */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; line-height: 1.5; min-height: 100vh; }
        button { cursor: pointer; border: none; background: none; font-family: inherit; }
        
        /* Utility */
        .hidden { display: none !important; }
        .flex { display: flex; } .flex-col { flex-direction: column; } .items-center { align-items: center; } 
        .justify-between { justify-content: space-between; } .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; } .gap-4 { gap: 1rem; } .w-full { width: 100%; }
        .text-center { text-align: center; } .font-bold { font-weight: 700; } .font-semibold { font-weight: 600; }
        .text-sm { font-size: 0.875rem; } .text-xs { font-size: 0.75rem; } .text-2xl { font-size: 1.5rem; }

        /* --- Header Styling (Updated) --- */
        header { 
            background: linear-gradient(to right, var(--header-bg-start), var(--header-bg-end)); 
            color: white; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
            margin-bottom: 2rem; 
            padding: 0.75rem 1.5rem; 
        }
        
        .header-content { 
            max-width: var(--container-max-width); 
            margin: 0 auto; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            flex-wrap: wrap; 
            gap: 1rem;
        }

        /* Left: User Info (Text first, then Image) */
        .user-area { 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
            flex: 1;
        }
        .avatar { 
            height: 2.5rem; 
            width: 2.5rem; 
            border-radius: 50%; 
            border: 2px solid rgba(255,255,255,0.8); 
            object-fit: cover; 
        }
        #userInfo { font-weight: 600; font-size: 0.95rem; }

        /* Center: Brand & Slogan */
        .brand-area {
            flex: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .logo-text { font-size: 1.75rem; font-weight: 800; letter-spacing: -0.025em; line-height: 1.2; }
        .tagline { font-size: 0.8rem; color: rgba(255,255,255,0.9); font-weight: 400; }

        /* Right: Actions (Rectangle Buttons) */
        .actions-area { 
            display: flex; 
            align-items: center; 
            gap: 0.75rem; 
            flex: 1; 
            justify-content: flex-end;
        }
        
        .btn-header {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm); /* Rectangle */
            font-weight: 600;
            font-size: 0.85rem;
            transition: background 0.2s;
        }
        .btn-header:hover { background-color: rgba(255, 255, 255, 0.3); }
        .btn-logout { background-color: var(--danger-bg); }
        .btn-logout:hover { background-color: #dc2626; }

        /* Theme Icon Button */
        .btn-icon-circle {
            padding: 0.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }
        .btn-icon-circle:hover { background-color: rgba(255, 255, 255, 0.3); }

        /* --- Main Layout --- */
        #app { max-width: 1280px; margin: 0 auto; padding: 1rem; padding-bottom: 6rem; }
        
        /* --- Grid & Cards --- */
        .cafe-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 1rem; 
        }
        @media (min-width: 768px) {
            .cafe-grid { grid-template-columns: repeat(4, 1fr); }
        }

        .cafe-box { 
            background-color: var(--bg-secondary); 
            border: 1px solid var(--border-color); 
            border-radius: var(--radius-md); 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            cursor: pointer; 
            overflow: hidden; 
            transition: transform 0.2s; 
        }
        .cafe-box:hover { transform: translateY(-4px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .cafe-box-media { 
            height: 140px; 
            background-color: var(--bg-primary); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        .cafe-box-media img { width: 100%; height: 100%; object-fit: cover; }
        .cafe-box-media-text { font-size: 1.25rem; font-weight: 700; color: var(--text-secondary); }
        .cafe-box-name { padding: 0.75rem; text-align: center; font-weight: 600; }

        /* --- Modals (Fixed Scrolling) --- */
        .modal-backdrop { 
            position: fixed; inset: 0; z-index: 50; 
            background-color: rgba(0, 0, 0, 0.6); 
            backdrop-filter: blur(2px); 
            display: flex; align-items: center; justify-content: center; 
            padding: 1rem; 
            transition: opacity 0.2s ease;
        }
        .modal-content { 
            background-color: var(--bg-secondary); 
            border-radius: var(--radius-lg); 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); 
            width: 100%; 
            max-height: 85vh; /* Limit height */
            display: flex; 
            flex-direction: column; /* Allow flex layout for children */
            transition: transform 0.2s ease;
        }
        .modal-content.max-w-lg { max-width: 32rem; }
        .modal-content.max-w-md { max-width: 28rem; }
        .modal-content.max-w-sm { max-width: 24rem; }

        /* The Scrollable Area */
        .scrollable-y { 
            overflow-y: auto; 
            padding: 0 0.5rem; 
            flex: 1; /* Take remaining space */
            margin-bottom: 1rem;
        }

        /* --- Lists & Items --- */
        .menu-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0.75rem; border-radius: var(--radius-md); 
            background-color: var(--bg-primary); margin-bottom: 0.5rem; 
        }
        .cart-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); margin-bottom: 0.75rem; 
        }
        .card-panel { 
            background: var(--bg-secondary); padding: 1rem; 
            border-radius: var(--radius-md); border: 1px solid var(--border-color); 
            margin-bottom: 1rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
        }

        /* --- Buttons --- */
        .btn { padding: 0.5rem 1rem; border-radius: var(--radius-md); font-weight: 600; transition: opacity 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn:hover { opacity: 0.9; }
        .btn-google { background: #4285F4; color: white; width: 100%; padding: 0.75rem; }
        .btn-student { background: #6366f1; color: white; width: 100%; padding: 1rem; margin-bottom: 0.5rem; }
        .btn-deliverer { background: var(--success-bg); color: white; width: 100%; padding: 1rem; }
        .btn-accent { background: var(--accent-color); color: white; }
        .btn-secondary { background: #e5e7eb; color: #374151; } .dark .btn-secondary { background: #374151; color: white; }
        .btn-danger { background: var(--danger-bg); color: white; }
        .btn-sm { padding: 0.25rem 0.75rem; font-size: 0.8rem; }
        .btn-qty { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; background: #e5e7eb; color: black; }
        .btn-qty.add { background: var(--accent-color); color: white; }

        /* --- Footer & Floating --- */
        footer { margin-top: 4rem; padding: 2rem; border-top: 1px solid var(--border-color); text-align: center; color: var(--text-muted); }
        #cart-button { position: fixed; bottom: 2rem; right: 2rem; background: var(--accent-color); color: white; padding: 0.75rem 1.5rem; border-radius: 999px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 40; }
        #active-order-bar { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); border-top: 1px solid var(--border-color); padding: 1rem; cursor: pointer; z-index: 30; }
        .active-order-content { max-width: 1280px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }

        /* --- Form --- */
        .form-select, .form-input { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: var(--bg-secondary); color: var(--text-primary); }

        /* Badge */
        .badge { padding: 0.2rem 0.6rem; border-radius: 99px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .badge-open { background: #d1fae5; color: #065f46; }
        .badge-progress { background: #fef3c7; color: #92400e; }
        .badge-completed { background: #dbeafe; color: #1e40af; }

        /* Loading */
        .animate-spin { animation: spin 1s linear infinite; } @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Mobile Tweaks */
        @media (max-width: 640px) {
            .header-content { flex-direction: column; gap: 1rem; }
            .user-area { width: 100%; justify-content: center; }
            .brand-area { order: -1; margin-bottom: 0.5rem; }
            .actions-area { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

    <div id="login-modal" class="modal-backdrop">
        <div class="login-card" style="background: var(--bg-secondary); padding: 2rem; border-radius: 1rem; width: 100%; max-width: 400px; text-align: center; border: 1px solid var(--border-color);">
            <h2 class="text-2xl font-bold mb-4" style="color: var(--accent-color);">Welcome to Gravli</h2>
            <p class="mb-8" style="color: var(--text-secondary);">Sign in to continue</p>
            <button id="google-signin-btn" class="btn btn-google">Sign in with Google</button>
        </div>
    </div>

    <div id="role-selection-modal" class="modal-backdrop hidden">
        <div class="modal-content max-w-sm" style="padding: 2rem; text-align: center;">
            <h2 class="text-2xl font-bold mb-2" style="color: var(--accent-color);">Choose Role</h2>
            <div class="flex flex-col gap-4 mt-6">
                <button id="select-student-btn" class="btn btn-student">Order Food</button>
                <button id="select-deliverer-btn" class="btn btn-deliverer">Deliver Orders</button>
            </div>
        </div>
    </div>

    <header id="main-header" class="hidden">
        <div class="header-content">
            
            <div class="user-area">
                <span id="userInfo">Loading...</span>
                <img id="user-avatar" class="avatar hidden" alt="User">
            </div>

            <div class="brand-area">
                <div class="logo-text">Gravli</div>
                <p class="tagline">Your on-campus delivery solution.</p>
            </div>

            <div class="actions-area">
                <div id="delivery-stats" class="badge badge-progress hidden" style="margin-right:0.5rem;">0 Delivers</div>
                
                <button id="order-history-btn" class="btn-header">History</button>
                <button id="logout-btn" class="btn-header btn-logout">Logout</button>
                
                <button id="theme-switcher" class="btn-icon-circle">
                    <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    <svg id="moon-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <div id="app" class="hidden">
        <main id="main-content">
            <div id="student-view">
                <div id="new-order-section" style="margin-bottom: 3rem;">
                    <h2 class="text-2xl font-bold mb-6">Cafes</h2>
                    <div id="cafe-grid-container" class="cafe-grid"></div>
                </div>
                <div id="my-orders-section">
                    <h2 class="text-2xl font-bold mb-4">Your Orders</h2>
                    <div id="my-requests-list" class="flex flex-col gap-4"></div>
                </div>
            </div>

            <div id="deliverer-view" class="hidden">
                <h2 class="text-2xl font-bold mb-4">My Current Job</h2>
                <div id="my-current-deliveries-list" class="flex flex-col gap-4 mb-8"></div>
                <div id="single-delivery-message" class="hidden card-panel text-center text-secondary"><p>Complete current job to see more.</p></div>
                
                <h2 class="text-2xl font-bold mb-4">Available Jobs</h2>
                <div id="all-requests-list-deliverer" class="flex flex-col gap-4"></div>
            </div>
        </main>
        
        <div id="loader" class="text-center py-10 hidden">
            <svg class="animate-spin h-8 w-8 mx-auto" style="color: var(--accent-color);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-2 text-secondary">Fetching data...</p>
        </div>
    </div>

    <button id="cart-button" class="hidden"><span id="cart-button-text">View Cart</span></button>
    <div id="active-order-bar" class="hidden">
        <div class="active-order-content">
            <div><span class="text-sm">Status: </span><span id="active-order-bar-status" class="font-bold text-accent">Loading...</span></div>
            <span class="text-sm font-semibold">View &uarr;</span>
        </div>
    </div>

    <div id="menu-modal" class="modal-backdrop hidden opacity-0">
        <div id="menu-modal-content" class="modal-content max-w-lg scale-95" style="padding: 1.5rem;">
            <div class="flex justify-between items-center mb-4 border-b border-color pb-2">
                <h3 id="menu-modal-title" class="text-2xl font-bold">Menu</h3>
                <button id="menu-close-btn" style="font-size: 1.5rem;">&times;</button>
            </div>
            <div id="menu-items-container" class="scrollable-y"></div>
        </div>
    </div>

    <div id="cart-modal" class="modal-backdrop hidden opacity-0">
        <div id="cart-modal-content" class="modal-content max-w-lg scale-95" style="padding: 1.5rem;">
            <div class="flex justify-between items-center mb-4 border-b border-color pb-2">
                <h3 class="text-2xl font-bold">Your Cart</h3>
                <button id="cart-close-btn" style="font-size: 1.5rem;">&times;</button>
            </div>
            <div id="cart-items-container" class="scrollable-y"></div>
            <div style="border-top: 1px solid var(--border-color); padding-top: 1rem;">
                <div class="flex justify-between font-bold text-lg mb-4"><span>Total</span><span id="cart-total-price">₹0.00</span></div>
                <button id="checkout-btn" class="btn btn-accent w-full">Proceed to Checkout</button>
            </div>
        </div>
    </div>

    <div id="checkout-modal" class="modal-backdrop hidden opacity-0">
        <div id="checkout-modal-content" class="modal-content max-w-md scale-95" style="padding: 1.5rem;">
            <h3 class="text-2xl font-bold mb-4">Confirm Order</h3>
            <form id="checkout-form">
                <div class="flex gap-4 mb-4">
                    <div style="flex:1">
                        <label class="block text-sm font-semibold mb-1">Block</label>
                        <select id="block-select" class="form-select" required>
                            <option value="" disabled selected>Select</option>
                            <option value="B1">B1</option>
                            <option value="B2">B2</option>
                            <option value="B3">B3</option>
                            <option value="B4">B4</option>
                            <option value="G1">G1</option>
                            <option value="G2">G2</option>
                            <option value="Library">Library</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                    <div style="flex:1">
                        <label class="block text-sm font-semibold mb-1">Room</label>
                        <input id="room-input" type="text" pattern="\d{3}" maxlength="3" class="form-input" placeholder="102" required>
                    </div>
                </div>
                <div class="text-center bg-primary p-3 rounded mb-4">
                    <p class="text-sm">Total to Pay</p>
                    <p id="checkout-total-display" class="text-xl font-bold text-accent">₹0.00</p>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="checkout-cancel-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-accent">Order Now</button>
                </div>
            </form>
        </div>
    </div>

    <div id="loading-modal" class="modal-backdrop hidden">
        <div class="bg-white p-6 rounded-lg text-center">
            <svg class="animate-spin h-8 w-8 mx-auto text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-2 font-semibold">Processing...</p>
        </div>
    </div>

    <div id="history-modal" class="modal-backdrop hidden opacity-0">
        <div id="history-modal-content" class="modal-content max-w-2xl scale-95" style="padding: 1.5rem;">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-2xl font-bold">Order History</h3>
                <button id="history-close-btn" style="font-size: 1.5rem;">&times;</button>
            </div>
            <div id="history-items-container" class="scrollable-y"></div>
        </div>
    </div>

    <footer>
        <p>Made by Students, For Students</p>
    </footer>

    <script type="module">
        // --- CONFIGURATION ---
        const APP_CONFIG = {
            deliveryFee: 50.00,
            firebase: {
                apiKey: "AIzaSyBnStrl0raNIb9Gr9-TtNzSImwbOQ36l_w",
                authDomain: "linkdash-3865d.firebaseapp.com",
                projectId: "linkdash-3865d",
                storageBucket: "linkdash-3865d.firebasestorage.app",
                messagingSenderId: "337760264309",
                appId: "1:337760264309:web:de20eaa36f7b9de688983c",
                measurementId: "G-RXLFFT5F2K"
            }
        };

        // --- FIREBASE IMPORT ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, updateDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp(APP_CONFIG.firebase);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- CAFE DATA ---
        // Edit items here
        const CAFE_DATA = {
            "HR1": { name: "HR1", image: "", items: [{id:"h1a",name:"Tea",price:10}, {id:"h1b",name:"Coffee",price:20}, {id:"h1c",name:"Patties",price:25}] },
            "HR2": { name: "HR2", image: "", items: [{id:"h2a",name:"Burger",price:45}, {id:"h2b",name:"Fries",price:50}] },
            "HR3": { name: "HR3", image: "", items: [{id:"h3a",name:"Maggie",price:30}] },
            "HR4": { name: "HR4", image: "", items: [{id:"h4a",name:"Pasta",price:60}] },
            "HR5": { name: "HR5", image: "", items: [{id:"h5a",name:"Pizza",price:120}] },
            "HR6": { name: "HR6", image: "", items: [{id:"h6a",name:"Sandwich",price:50}] },
            "HR7": { name: "HR7", image: "", items: [{id:"h7a",name:"Rolls",price:80}] },
            "HR8": { name: "HR8", image: "", items: [{id:"h8a",name:"Juice",price:40}] },
            "HR9": { name: "HR9", image: "", items: [{id:"h9a",name:"Shake",price:60}] },
            "HR10": { name: "HR10", image: "", items: [{id:"h10a",name:"Thali",price:100}] },
            "HR11": { name: "HR11", image: "", items: [{id:"h11a",name:"Dosa",price:70}] },
            "HR12": { name: "HR12", image: "", items: [{id:"h12a",name:"Chowmein",price:50}] },
        };

        // --- STATE ---
        let state = { user: null, role: null, cart: {}, activeCafe: null, unsub: null };

        // --- DOM ---
        const UI = {
            login: document.getElementById('login-modal'),
            role: document.getElementById('role-selection-modal'),
            app: document.getElementById('app'),
            header: document.getElementById('main-header'),
            studentView: document.getElementById('student-view'),
            delivererView: document.getElementById('deliverer-view'),
            loader: document.getElementById('loader')
        };

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.user = { uid: user.uid, name: user.displayName, photo: user.photoURL };
                UI.login.classList.add('hidden');
                
                const savedRole = localStorage.getItem('role');
                if (savedRole) {
                    setRole(savedRole);
                } else {
                    UI.role.classList.remove('hidden');
                }
                updateHeader();
            } else {
                state = { user: null, role: null, cart: {}, activeCafe: null, unsub: null };
                localStorage.removeItem('role');
                UI.login.classList.remove('hidden');
                UI.app.classList.add('hidden');
                UI.header.classList.add('hidden');
                UI.role.classList.add('hidden');
            }
        });

        function updateHeader() {
            document.getElementById('userInfo').textContent = `Hi, ${state.user.name}!`;
            const avatar = document.getElementById('user-avatar');
            if (state.user.photo) {
                avatar.src = state.user.photo;
                avatar.classList.remove('hidden');
            }
            UI.header.classList.remove('hidden');
        }

        function setRole(role) {
            state.role = role;
            localStorage.setItem('role', role);
            UI.role.classList.add('hidden');
            UI.app.classList.remove('hidden');
            
            if (role === 'student') {
                UI.studentView.classList.remove('hidden');
                UI.delivererView.classList.add('hidden');
                document.getElementById('cart-button').classList.add('hidden');
                renderCafes();
            } else {
                UI.studentView.classList.add('hidden');
                UI.delivererView.classList.remove('hidden');
                document.getElementById('cart-button').classList.add('hidden');
                document.getElementById('delivery-stats').classList.remove('hidden');
            }
            fetchData();
        }

        // --- THEME LOGIC ---
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            document.getElementById('sun-icon').classList.toggle('hidden', isDark);
            document.getElementById('moon-icon').classList.toggle('hidden', !isDark);
        }
        document.getElementById('theme-switcher').addEventListener('click', toggleTheme);

        // --- CAFE & MENU ---
        function renderCafes() {
            const container = document.getElementById('cafe-grid-container');
            container.innerHTML = '';
            Object.entries(CAFE_DATA).forEach(([id, cafe]) => {
                const div = document.createElement('div');
                div.className = 'cafe-box';
                div.innerHTML = `
                    <div class="cafe-box-media">
                        ${cafe.image ? `<img src="${cafe.image}">` : `<span class="cafe-box-media-text">${cafe.name}</span>`}
                    </div>
                    <div class="cafe-box-name">${cafe.name}</div>
                `;
                div.onclick = () => openMenu(id);
                container.appendChild(div);
            });
        }

        function openMenu(id) {
            state.activeCafe = id;
            const modal = document.getElementById('menu-modal');
            const container = document.getElementById('menu-items-container');
            document.getElementById('menu-modal-title').textContent = CAFE_DATA[id].name;
            container.innerHTML = '';

            CAFE_DATA[id].items.forEach(item => {
                const qty = state.cart[item.id]?.qty || 0;
                const div = document.createElement('div');
                div.className = 'menu-item';
                div.innerHTML = `
                    <div><p class="font-bold">${item.name}</p><p class="text-sm">₹${item.price}</p></div>
                    <div class="flex items-center gap-2">
                        <button class="btn-qty" onclick="modCart('${item.id}',-1)">-</button>
                        <span class="font-bold w-6 text-center">${qty}</span>
                        <button class="btn-qty add" onclick="modCart('${item.id}',1)">+</button>
                    </div>
                `;
                // Manually bind for module scope
                div.querySelectorAll('button')[0].onclick = () => modCart(item.id, -1);
                div.querySelectorAll('button')[1].onclick = () => modCart(item.id, 1);
                container.appendChild(div);
            });
            toggleModal(modal, true);
        }

        function modCart(itemId, change) {
            const cafe = CAFE_DATA[state.activeCafe];
            const item = cafe.items.find(i => i.id === itemId);
            
            // Clear check
            const currentFirst = Object.values(state.cart)[0];
            if (currentFirst && currentFirst.cafeId !== state.activeCafe) {
                if(!confirm("Clear cart to order from new cafe?")) return;
                state.cart = {};
            }

            if (!state.cart[itemId]) state.cart[itemId] = { ...item, qty: 0, cafeId: state.activeCafe, cafeName: cafe.name };
            state.cart[itemId].qty += change;
            if (state.cart[itemId].qty <= 0) delete state.cart[itemId];
            
            // Re-render menu qty
            openMenu(state.activeCafe); 
            updateCartBtn();
        }

        function updateCartBtn() {
            const total = Object.values(state.cart).reduce((a,b)=>a+b.qty,0);
            const btn = document.getElementById('cart-button');
            if(total > 0 && state.role === 'student') {
                btn.classList.remove('hidden');
                document.getElementById('cart-button-text').textContent = `View Cart (${total})`;
            } else {
                btn.classList.add('hidden');
            }
        }

        // --- CART & ORDER ---
        document.getElementById('cart-button').onclick = () => {
            const container = document.getElementById('cart-items-container');
            container.innerHTML = '';
            let total = 0;
            Object.values(state.cart).forEach(item => {
                total += item.price * item.qty;
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `<div>${item.name} x${item.qty}</div><div>₹${item.price * item.qty}</div>`;
                container.appendChild(div);
            });
            document.getElementById('cart-total-price').textContent = `₹${total}`;
            toggleModal(document.getElementById('cart-modal'), true);
        };

        document.getElementById('checkout-btn').onclick = () => {
            toggleModal(document.getElementById('cart-modal'), false);
            const total = Object.values(state.cart).reduce((a,b)=>a+(b.price*b.qty),0) + APP_CONFIG.deliveryFee;
            document.getElementById('checkout-total-display').textContent = `₹${total}`;
            toggleModal(document.getElementById('checkout-modal'), true);
        };

        document.getElementById('checkout-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            toggleModal(document.getElementById('loading-modal'), true);
            
            const block = document.getElementById('block-select').value;
            const room = document.getElementById('room-input').value;
            const items = Object.values(state.cart);
            const itemPrice = items.reduce((a,b)=>a+(b.price*b.qty),0);
            
            try {
                await addDoc(collection(db, `orders`), {
                    items, itemPrice, deliveryFee: APP_CONFIG.deliveryFee,
                    total: itemPrice + APP_CONFIG.deliveryFee,
                    loc: `${block}-${room}`, cafe: items[0].cafeName,
                    status: 'open', reqId: state.user.uid, reqName: state.user.name,
                    ts: serverTimestamp()
                });
                state.cart = {}; updateCartBtn();
                toggleModal(document.getElementById('checkout-modal'), false);
            } catch(err) { alert("Error placing order"); console.error(err); }
            finally { 
                toggleModal(document.getElementById('loading-modal'), false); 
                btn.disabled = false; 
            }
        };

        // --- DATA FETCHING (Fixed) ---
        function fetchData() {
            if (state.unsub) state.unsub();
            UI.loader.classList.remove('hidden');
            
            const q = query(collection(db, 'orders'));
            state.unsub = onSnapshot(q, (snap) => {
                UI.loader.classList.add('hidden'); // Ensure loader hides
                const list = [];
                snap.forEach(d => list.push({id: d.id, ...d.data()}));
                list.sort((a,b) => (b.ts?.seconds||0) - (a.ts?.seconds||0));
                renderOrders(list);
            });
        }

        function renderOrders(list) {
            const myReqs = list.filter(o => o.reqId === state.user.uid);
            const active = myReqs.filter(o => o.status !== 'completed');
            
            // Student View
            const sList = document.getElementById('my-requests-list');
            sList.innerHTML = active.length ? '' : '<p class="text-center text-secondary py-4">No active orders</p>';
            active.forEach(o => sList.appendChild(makeCard(o, 'student')));

            const inProg = active.find(o => o.status === 'in-progress');
            if(inProg && state.role === 'student') {
                document.getElementById('active-order-bar').classList.remove('hidden');
                document.getElementById('active-order-bar-status').textContent = inProg.subStatus || 'On the way';
            } else {
                document.getElementById('active-order-bar').classList.add('hidden');
            }

            // Deliverer View
            if (state.role === 'deliverer') {
                const dList = document.getElementById('my-current-deliveries-list');
                const job = list.find(o => o.delId === state.user.uid && o.status === 'in-progress');
                dList.innerHTML = job ? '' : '<p class="text-center text-secondary">No active jobs</p>';
                if(job) dList.appendChild(makeCard(job, 'deliverer-active'));

                const openList = document.getElementById('all-requests-list-deliverer');
                const openJobs = list.filter(o => o.status === 'open');
                openList.innerHTML = openJobs.length ? '' : '<p class="text-center text-secondary">No available jobs</p>';
                if(!job) openJobs.forEach(o => openList.appendChild(makeCard(o, 'deliverer-open')));
            }
            
            // History
            window.historyList = list; // Store for modal
        }

        function makeCard(o, type) {
            const div = document.createElement('div');
            div.className = 'card-panel';
            const itemTxt = o.items.map(i=>`${i.name} x${i.qty}`).join(', ');
            
            let action = '';
            if (type === 'student' && o.status === 'open') {
                action = `<button class="btn btn-danger btn-sm w-full mt-2" onclick="act('${o.id}','cancel')">Cancel</button>`;
            } else if (type === 'deliverer-open') {
                action = o.reqId !== state.user.uid 
                    ? `<button class="btn btn-deliverer btn-sm w-full mt-2" onclick="act('${o.id}','accept')">Accept (₹${o.deliveryFee})</button>`
                    : `<p class="text-xs text-center italic mt-2">Your Order</p>`;
            } else if (type === 'deliverer-active') {
                action = `<div class="flex flex-col gap-2 mt-2">
                    ${!o.eta ? `<div class="flex gap-2"><input id="eta-${o.id}" type="number" class="form-input text-xs" placeholder="Mins"><button class="btn btn-accent btn-sm" onclick="act('${o.id}','eta')">Set</button></div>` : `<p class="text-xs text-green-600 font-bold">ETA: ${o.eta}m</p>`}
                    ${!o.subStatus ? `<button class="btn btn-accent btn-sm w-full" onclick="act('${o.id}','reached')">Reached Cafe</button>` :
                      o.subStatus === 'reached' ? `<button class="btn btn-accent btn-sm w-full" onclick="act('${o.id}','picked')">Picked Up</button>` :
                      `<button class="btn btn-success btn-sm w-full" style="background:var(--info-bg);color:white" onclick="act('${o.id}','done')">Delivered</button>`}
                </div>`;
            }

            div.innerHTML = `
                <div class="flex justify-between mb-1"><span class="font-bold text-accent">${itemTxt}</span><span class="badge badge-${o.status}">${o.status}</span></div>
                <p class="text-sm text-secondary">${o.cafe} &rarr; ${o.loc}</p>
                <div class="flex justify-between items-end mt-2">
                    <span class="font-bold">₹${o.total}</span>
                    <div style="min-width:100px">${action}</div>
                </div>
            `;
            // Bind actions
            div.querySelectorAll('button').forEach(b => {
                const call = b.getAttribute('onclick');
                if(call) {
                    const [id, actType] = call.match(/'([^']+)'/g).map(s=>s.replace(/'/g,''));
                    b.onclick = () => handleAct(id, actType);
                    b.removeAttribute('onclick');
                }
            });
            return div;
        }

        async function handleAct(id, type) {
            const ref = doc(db, 'orders', id);
            if(type==='cancel') await deleteDoc(ref);
            if(type==='accept') await updateDoc(ref, { status:'in-progress', delId:state.user.uid, delName:state.user.name });
            if(type==='eta') { const v=document.getElementById(`eta-${id}`).value; if(v) await updateDoc(ref,{eta:v}); }
            if(type==='reached') await updateDoc(ref, { subStatus:'reached' });
            if(type==='picked') await updateDoc(ref, { subStatus:'picked' });
            if(type==='done') await updateDoc(ref, { status:'completed' });
        }

        // --- HELPERS ---
        function toggleModal(el, show) {
            if(show) { el.classList.remove('hidden'); setTimeout(()=>el.classList.remove('opacity-0'),10); }
            else { el.classList.add('opacity-0'); setTimeout(()=>el.classList.add('hidden'),300); }
        }
        
        // --- BUTTONS ---
        document.getElementById('google-signin-btn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        document.getElementById('logout-btn').onclick = () => signOut(auth);
        document.getElementById('select-student-btn').onclick = () => setRole('student');
        document.getElementById('select-deliverer-btn').onclick = () => setRole('deliverer');
        
        document.getElementById('menu-close-btn').onclick = () => toggleModal(document.getElementById('menu-modal'), false);
        document.getElementById('cart-close-btn').onclick = () => toggleModal(document.getElementById('cart-modal'), false);
        document.getElementById('checkout-cancel-btn').onclick = () => toggleModal(document.getElementById('checkout-modal'), false);
        
        document.getElementById('order-history-btn').onclick = () => {
            const container = document.getElementById('history-items-container');
            container.innerHTML = '';
            const list = (window.historyList || []).filter(o => o.status === 'completed' && (state.role==='student' ? o.reqId===state.user.uid : o.delId===state.user.uid));
            if(!list.length) container.innerHTML = '<p class="text-center py-4">No history</p>';
            list.forEach(o => {
                const d = document.createElement('div');
                d.className = 'card-panel';
                d.innerHTML = `<p class="font-bold">${o.items.map(i=>i.name).join(', ')}</p><p class="text-sm">Total: ₹${o.total}</p>`;
                container.appendChild(d);
            });
            toggleModal(document.getElementById('history-modal'), true);
        };
        document.getElementById('history-close-btn').onclick = () => toggleModal(document.getElementById('history-modal'), false);

    </script>
</body>
</html>
