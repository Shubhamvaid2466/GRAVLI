<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gravli - Campus Delivery</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- CSS Variables --- */
        :root {
            --bg-primary: #f3f4f6;
            --bg-secondary: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-muted: #9ca3af;
            --border-color: #e5e7eb;
            --accent-color: #8b5cf6;
            --accent-hover: #7c3aed;
            --success-bg: #22c55e;
            --danger-bg: #ef4444;
            --info-bg: #3b82f6;
            --header-bg-start: #7c3aed;
            --header-bg-end: #4f46e5;

            --container-max-width: 1280px;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-full: 9999px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .dark {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --text-muted: #6b7280;
            --border-color: #374151;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.5);
        }
        
        /* Base Reset */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary); transition: background-color 0.3s ease, color 0.3s ease; line-height: 1.5; height: 100vh; }
        button { cursor: pointer; border: none; background: none; font-family: inherit; }
        
        /* Utilities */
        .hidden { display: none !important; }
        .flex { display: flex; } .flex-col { flex-direction: column; } .items-center { align-items: center; } .justify-between { justify-content: space-between; } .gap-2 { gap: 0.5rem; } .gap-4 { gap: 1rem; } .w-full { width: 100%; }
        .text-center { text-align: center; } .font-bold { font-weight: 700; } .font-semibold { font-weight: 600; } .text-sm { font-size: 0.875rem; } .text-xs { font-size: 0.75rem; } .text-2xl { font-size: 1.5rem; }

        /* Modals */
        .modal-backdrop { position: fixed; inset: 0; z-index: 50; background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; padding: 1rem; transition: opacity 0.3s ease; }
        .modal-content { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-lg); box-shadow: var(--shadow-xl); width: 100%; max-height: 90vh; transition: transform 0.3s ease, opacity 0.3s ease; overflow: hidden; display: flex; flex-direction: column; }
        .scrollable-y { overflow-y: auto; flex: 1; min-height: 0; padding-right: 0.5rem; }
        .modal-content.max-w-sm { max-width: 24rem; } .modal-content.max-w-lg { max-width: 32rem; } .modal-content.max-w-2xl { max-width: 42rem; } .modal-content.max-w-md { max-width: 28rem; }
        
        /* Login Card */
        .login-card { background: linear-gradient(135deg, var(--bg-secondary) 0%, #303b4d 100%); color: white; padding: 2rem; border-radius: var(--radius-lg); width: 100%; max-width: 24rem; text-align: center; box-shadow: var(--shadow-xl); }
        .dark .login-card { background: linear-gradient(135deg, #1f2937 0%, #111827 100%); border: 1px solid var(--border-color); }

        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.75rem 1rem; border-radius: var(--radius-md); font-weight: 600; transition: background-color 0.2s, transform 0.1s; gap: 0.5rem; }
        .btn:active { transform: scale(0.98); }
        .btn-google { background-color: #3b82f6; color: white; width: 100%; } .btn-google:hover { background-color: #2563eb; }
        .btn-student { background-color: #6366f1; color: white; width: 100%; padding: 1rem; font-size: 1.125rem; } .btn-student:hover { background-color: #4f46e5; }
        .btn-deliverer { background-color: var(--success-bg); color: white; width: 100%; padding: 1rem; font-size: 1.125rem; } .btn-deliverer:hover { background-color: #16a34a; }
        .btn-accent { background-color: var(--accent-color); color: white; } .btn-accent:hover { background-color: var(--accent-hover); }
        .btn-danger { background-color: var(--danger-bg); color: white; } .btn-danger:hover { background-color: #dc2626; }
        .btn-secondary { background-color: #e5e7eb; color: var(--text-primary); } .dark .btn-secondary { background-color: #4b5563; color: white; } .btn-secondary:hover { opacity: 0.9; }
        .btn-sm { padding: 0.375rem 1rem; font-size: 0.75rem; } .btn-icon { padding: 0.5rem; border-radius: 50%; color: var(--text-secondary); } .btn-icon:hover { background-color: rgba(255,255,255,0.1); }
        .btn-round-qty { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* Header */
        header { background: linear-gradient(to right, var(--header-bg-start), var(--header-bg-end)); color: white; box-shadow: var(--shadow-lg); margin-bottom: 2rem; padding: 1rem 1.5rem; }
        .header-content { max-width: var(--container-max-width); margin: 0 auto; display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap; }
        .avatar { height: 2.25rem; width: 2.25rem; border-radius: 50%; border: 2px solid white; object-fit: cover; }
        .delivery-stats { background: rgba(255, 255, 255, 0.2); color: white; padding: 0.5rem 1rem; border-radius: var(--radius-full); font-weight: 600; font-size: 0.875rem; white-space: nowrap; }

        /* Grid */
        #app { max-width: var(--container-max-width); margin: 0 auto; padding: 1rem; padding-bottom: 6rem; }
        .cafe-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        
        /* Cafe Box */
        .cafe-box { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--radius-md); box-shadow: var(--shadow-sm); cursor: pointer; transition: all 0.2s ease-in-out; overflow: hidden; display: flex; flex-direction: column; }
        .cafe-box:hover { transform: scale(1.03) translateY(-3px); box-shadow: var(--shadow-lg); }
        /* Box Header (Image or Text) */
        .cafe-box-media { height: 140px; background-color: var(--bg-primary); display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .cafe-box-media img { width: 100%; height: 100%; object-fit: cover; }
        .cafe-box-media-text { font-size: 1.5rem; font-weight: 700; color: var(--text-secondary); }
        .cafe-box-name { padding: 0.75rem; text-align: center; font-weight: 600; color: var(--text-primary); }

        /* General UI */
        .card-panel { background-color: var(--bg-secondary); padding: 1.25rem; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); border: 1px solid var(--border-color); margin-bottom: 1rem; }
        .menu-item, .cart-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border-radius: var(--radius-md); margin-bottom: 0.5rem; }
        .menu-item { background-color: var(--bg-primary); }
        .cart-item { border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
        
        /* Floating & Forms */
        #cart-button { position: fixed; bottom: 1.5rem; right: 1.5rem; z-index: 40; background-color: var(--accent-color); color: white; font-weight: 700; padding: 0.75rem 1.25rem; border-radius: 9999px; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 0.75rem; transition: all 0.3s; }
        #cart-button:hover { background-color: var(--accent-hover); transform: scale(1.05); }
        #active-order-bar { position: fixed; bottom: 0; left: 0; right: 0; z-index: 30; background-color: var(--bg-secondary); box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.1); border-top: 1px solid var(--border-color); padding: 1rem; cursor: pointer; }
        .form-select, .form-input { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius-md); background-color: var(--bg-secondary); color: var(--text-primary); font-size: 1rem; }

        /* Badges & Footer */
        .badge { padding: 0.125rem 0.625rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .badge-open { background-color: #d1fae5; color: #065f46; } 
        .badge-progress { background-color: #fef3c7; color: #92400e; } 
        .badge-completed { background-color: #dbeafe; color: #1e40af; } 
        footer { text-align: center; padding: 2.5rem; margin-top: 4rem; border-top: 1px solid var(--border-color); color: var(--text-muted); }

        /* Responsive */
        @media (min-width: 641px) { .cafe-grid { grid-template-columns: repeat(3, 1fr); } .cafe-box-media { height: 160px; } #app { padding: 1.5rem; } .modal-content { max-width: 90%; } }
        @media (min-width: 1025px) { .cafe-grid { grid-template-columns: repeat(4, 1fr); } .cafe-box-media { height: 180px; } }
        @media (max-width: 768px) { .header-content { flex-direction: column; text-align: center; } .logo-area { order: 1; } .user-area { order: 2; width: 100%; justify-content: center; } .actions-area { order: 3; width: 100%; justify-content: center; } }
        
        /* Helpers */
        .animate-spin { animation: spin 1s linear infinite; } @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .opacity-0 { opacity: 0; } .scale-95 { transform: scale(0.95); } .highlight-pulse { animation: pulseBg 2s ease; } @keyframes pulseBg { 0% { background-color: var(--bg-secondary); } 50% { background-color: rgba(139, 92, 246, 0.2); } 100% { background-color: var(--bg-secondary); } }
    </style>
</head>
<body>

    <div id="login-modal" class="modal-backdrop">
        <div class="login-card">
            <h2 class="text-2xl font-bold mb-4" style="color: var(--accent-color);">Welcome to Gravli!</h2>
            <p class="mb-8" style="color: #e5e7eb;">Sign in with your Google account to continue.</p>
            <button id="google-signin-btn" class="btn btn-google">Sign in with Google</button>
        </div>
    </div>

    <div id="role-selection-modal" class="modal-backdrop hidden">
        <div class="modal-content max-w-sm" style="padding: 2rem; text-align: center;">
            <h2 class="text-2xl font-bold mb-2" style="color: var(--accent-color);">What would you like to do?</h2>
            <p class="text-secondary mb-8">Choose your role for this session.</p>
            <div class="flex flex-col gap-4">
                <button id="select-student-btn" class="btn btn-student">Order Food</button>
                <button id="select-deliverer-btn" class="btn btn-deliverer">Deliver Orders</button>
            </div>
        </div>
    </div>

    <div id="loading-modal" class="modal-backdrop hidden">
        <div class="modal-content max-w-sm" style="padding: 2rem; text-align: center;">
            <svg class="animate-spin h-10 w-10 mx-auto" style="color: var(--accent-color);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-4 text-secondary font-semibold">Placing your order...</p>
        </div>
    </div>

    <div id="menu-modal" class="modal-backdrop hidden opacity-0">
        <div id="menu-modal-content" class="modal-content max-w-lg scale-95" style="padding: 1.5rem;">
            <div class="flex justify-between items-center mb-4">
                <h3 id="menu-modal-title" class="text-2xl font-bold">Menu</h3>
                <button id="menu-close-btn" style="color: var(--text-muted); font-size: 2rem; line-height: 1;">&times;</button>
            </div>
            <div id="menu-items-container" class="space-y-3 scrollable-y"></div>
        </div>
    </div>

    <div id="cart-modal" class="modal-backdrop hidden opacity-0">
        <div id="cart-modal-content" class="modal-content max-w-lg scale-95" style="padding: 1.5rem;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Your Cart</h3>
                <button id="cart-close-btn" style="color: var(--text-muted); font-size: 2rem; line-height: 1;">&times;</button>
            </div>
            <div id="cart-items-container" class="space-y-4 scrollable-y"></div>
            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                <div class="flex justify-between items-center font-bold" style="font-size: 1.125rem;"><span>Total</span><span id="cart-total-price">₹0.00</span></div>
                <button id="checkout-btn" class="btn btn-accent w-full mt-4">Proceed to Checkout</button>
            </div>
        </div>
    </div>

    <div id="checkout-modal" class="modal-backdrop hidden opacity-0">
        <div id="checkout-modal-content" class="modal-content max-w-md scale-95" style="padding: 1.5rem;">
            <h3 class="text-2xl font-bold mb-4">Confirm Order</h3>
            <form id="checkout-form">
                <label class="form-label mb-2">Drop-off Location</label>
                <div class="flex gap-4 mb-4">
                    <div class="form-group flex-1" style="margin-bottom: 0;">
                        <select id="block-select" class="form-select" required>
                            <option value="" disabled selected>Block</option>
                            <option value="B1">B1</option>
                            <option value="B2">B2</option>
                            <option value="B3">B3</option>
                            <option value="B4">B4</option>
                            <option value="G1">G1</option>
                            <option value="G2">G2</option>
                            <option value="Main Library">Main Library</option>
                            <option value="Admin Block">Admin Block</option>
                        </select>
                    </div>
                    <div class="form-group flex-1" style="margin-bottom: 0;">
                        <input id="room-input" type="text" inputmode="numeric" pattern="\d{3}" maxlength="3" class="form-input" placeholder="e.g., 102" required>
                    </div>
                </div>
                <div class="total-display">
                    <p class="text-secondary font-semibold">Total Amount (Item + Fee)</p>
                    <p id="checkout-total-display" class="text-primary text-2xl font-bold">₹0.00</p>
                </div>
                <p id="checkout-error-message" class="text-sm mb-4 text-center hidden" style="color: var(--danger-bg);"></p>
                <div class="flex justify-end gap-4">
                    <button type="button" id="checkout-cancel-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-accent">Confirm Order</button>
                </div>
            </form>
        </div>
    </div>

    <div id="history-modal" class="modal-backdrop hidden opacity-0">
        <div id="history-modal-content" class="modal-content max-w-2xl scale-95" style="padding: 1.5rem;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold">Order History</h3>
                <button id="history-close-btn" style="color: var(--text-muted); font-size: 2rem; line-height: 1;">&times;</button>
            </div>
            <div id="history-items-container" class="space-y-4 scrollable-y"></div>
        </div>
    </div>

    <header id="main-header" class="hidden">
        <div class="header-content">
            <div class="user-area">
                <img id="user-avatar" class="avatar hidden" alt="User">
                <div id="userInfo" class="text-sm" style="color: #c7d2fe;">Loading...</div>
            </div>
            <div class="logo-area">Gravli</div>
            <div class="actions-area">
                <div id="delivery-stats" class="delivery-stats hidden">Deliveries: 0</div>
                <button id="order-history-btn" class="hidden btn-icon" style="background:rgba(255,255,255,0.2); font-size:0.75rem;">History</button>
                <button id="logout-btn" class="hidden btn-icon" style="background:var(--danger-bg); font-size:0.75rem;">Logout</button>
                <button id="theme-switcher" class="btn-icon">Theme</button>
            </div>
        </div>
        <p class="logo-text-sm">Your on-campus delivery solution.</p>
    </header>

    <div id="app" class="hidden">
        <main id="main-content">
            <div id="student-view">
                <div id="new-order-section" style="margin-bottom: 3rem;">
                    <h2 class="text-2xl font-bold mb-6">Place a New Order</h2>
                    <div id="cafe-grid-container" class="cafe-grid"></div>
                </div>
                <div id="my-orders-section">
                    <h2 class="text-2xl font-bold mb-6">My Active Orders</h2>
                    <div id="my-requests-list" class="request-list"></div>
                </div>
            </div>
            <div id="deliverer-view" class="hidden">
                <h2 class="text-2xl font-bold mb-4">My Current Deliveries</h2>
                <div id="my-current-deliveries-list" class="request-list mb-8"></div>
                <div id="single-delivery-message" class="hidden card-panel text-center text-secondary"><p>Complete current job first.</p></div>
                <div id="available-deliveries-container">
                    <h2 class="text-2xl font-bold mb-6">Available Deliveries</h2>
                    <div id="all-requests-list-deliverer" class="request-list"></div>
                </div>
            </div>
        </main>
        <div id="loader" class="text-center py-10 hidden"><p>Fetching data...</p></div>
    </div>

    <button id="cart-button" class="hidden"><span id="cart-button-text">View Cart</span></button>
    <div id="active-order-bar" class="hidden">
        <div class="active-order-content">
            <div><p class="text-sm text-secondary">Status:</p><p id="active-order-bar-status" class="font-bold">Loading...</p></div>
            <span class="text-sm font-semibold">View &rarr;</span>
        </div>
    </div>

    <footer>
        <p class="font-semibold text-secondary">Made By Students, For Students</p>
    </footer>

    <script type="module">
        // --- 1. CONFIGURATION ---
        const APP_CONFIG = {
            deliveryFee: 50.00,
            orderExpirySeconds: 900,
            etaMaxMinutes: 40,
            firebase: {
                apiKey: "AIzaSyBnStrl0raNIb9Gr9-TtNzSImwbOQ36l_w",
                authDomain: "linkdash-3865d.firebaseapp.com",
                projectId: "linkdash-3865d",
                storageBucket: "linkdash-3865d.firebasestorage.app",
                messagingSenderId: "337760264309",
                appId: "1:337760264309:web:de20eaa36f7b9de688983c",
                measurementId: "G-RXLFFT5F2K"
            }
        };

        // --- 2. FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, updateDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp(APP_CONFIG.firebase);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- 3. CAFE DATA (Fully Editable) ---
        // Instructions:
        // 1. Change "name" to whatever you want (e.g. "Main Canteen").
        // 2. Change "image" to an image URL. If empty "", it uses text.
        // 3. Edit "items" array to change menu.
        
        const CAFE_DATA = {
            // --- CAFE 1 ---
            "HR1": { 
                name: "HR1",
                image: "", // Example: "https://via.placeholder.com/300"
                items: [
                    { id: "hr1_1", name: "Tea", price: 10 },
                    { id: "hr1_2", name: "Coffee", price: 20 },
                    { id: "hr1_3", name: "Sandwich", price: 50 },
                    { id: "hr1_4", name: "Maggi", price: 40 },
                    { id: "hr1_5", name: "Patties", price: 25 },
                    { id: "hr1_6", name: "Pastry", price: 60 }
                ] 
            },
            
            // --- CAFE 2 ---
            "HR2": { 
                name: "HR2",
                image: "",
                items: [
                    { id: "hr2_1", name: "Cold Coffee", price: 60 },
                    { id: "hr2_2", name: "Burger", price: 45 },
                    { id: "hr2_3", name: "Fries", price: 50 }
                ] 
            },

            // --- CAFE 3 ---
            "HR3": { 
                name: "HR3", 
                image: "", 
                items: [{ id: "hr3_1", name: "Item 1", price: 100 }, { id: "hr3_2", name: "Item 2", price: 150 }] 
            },

            // --- CAFE 4 ---
            "HR4": { name: "HR4", image: "", items: [{ id: "hr4_1", name: "Item 1", price: 100 }] },
            
            // --- CAFE 5 ---
            "HR5": { name: "HR5", image: "", items: [{ id: "hr5_1", name: "Item 1", price: 100 }] },
            
            // --- CAFE 6 ---
            "HR6": { name: "HR6", image: "", items: [{ id: "hr6_1", name: "Item 1", price: 100 }] },
            
            // --- CAFE 7 ---
            "HR7": { name: "HR7", image: "", items: [{ id: "hr7_1", name: "Item 1", price: 100 }] },
            
            // --- CAFE 8 ---
            "HR8": { name: "HR8", image: "", items: [{ id: "hr8_1", name: "Item 1", price: 100 }] },
            
            // --- CAFE 9 ---
            "HR9": { name: "HR9", image: "", items: [{ id: "hr9_1", name: "Item 1", price: 100 }] },
            
            // --- CAFE 10 ---
            "HR10": { name: "HR10", image: "", items: [{ id: "hr10_1", name: "Item 1", price: 100 }] },
            
            // --- CAFE 11 ---
            "HR11": { name: "HR11", image: "", items: [{ id: "hr11_1", name: "Item 1", price: 100 }] },
            
            // --- CAFE 12 ---
            "HR12": { name: "HR12", image: "", items: [{ id: "hr12_1", name: "Item 1", price: 100 }] },
        };

        // --- 4. STATE & UI ---
        let state = { currentUser: null, userDetails: null, cart: {}, currentOpenCafeId: null, currentRole: null, unsubscribe: null };
        const UI = {
            modals: { login: document.getElementById('login-modal'), role: document.getElementById('role-selection-modal'), menu: document.getElementById('menu-modal'), cart: document.getElementById('cart-modal'), checkout: document.getElementById('checkout-modal'), loading: document.getElementById('loading-modal'), history: document.getElementById('history-modal') },
            views: { student: document.getElementById('student-view'), deliverer: document.getElementById('deliverer-view'), app: document.getElementById('app') },
            buttons: { googleSignIn: document.getElementById('google-signin-btn'), student: document.getElementById('select-student-btn'), deliverer: document.getElementById('select-deliverer-btn'), logout: document.getElementById('logout-btn'), theme: document.getElementById('theme-switcher') }
        };

        // --- 5. THEME & AUTH ---
        UI.buttons.theme.addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });
        if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');

        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.currentUser = user;
                state.userDetails = { name: user.displayName, uid: user.uid, photoURL: user.photoURL };
                UI.modals.login.classList.add('hidden');
                
                const savedRole = localStorage.getItem('userRole');
                if (savedRole) {
                    state.currentRole = savedRole;
                    UI.modals.role.classList.add('hidden');
                    updateViewBasedOnRole();
                    setupHeader();
                    startApp();
                } else {
                    UI.modals.role.classList.remove('hidden');
                    setupHeader();
                }
            } else {
                state = { currentUser: null, userDetails: null, cart: {}, currentOpenCafeId: null, currentRole: null, unsubscribe: null };
                localStorage.removeItem('userRole');
                UI.modals.login.classList.remove('hidden');
                UI.modals.role.classList.add('hidden');
                UI.views.app.classList.add('hidden');
                document.getElementById('main-header').classList.add('hidden');
            }
        });

        function updateViewBasedOnRole() {
            if (state.currentRole === 'student') {
                UI.views.student.classList.remove('hidden');
                UI.views.deliverer.classList.add('hidden');
                document.getElementById('cart-button').classList.add('hidden');
                document.getElementById('delivery-stats').classList.add('hidden');
            } else {
                UI.views.student.classList.add('hidden');
                UI.views.deliverer.classList.remove('hidden');
                document.getElementById('cart-button').classList.add('hidden');
                document.getElementById('delivery-stats').classList.remove('hidden');
            }
        }

        function setupHeader() {
            document.getElementById('userInfo').textContent = `Hi, ${state.userDetails.name}!`;
            if (state.userDetails.photoURL) {
                const avatar = document.getElementById('user-avatar');
                avatar.src = state.userDetails.photoURL;
                avatar.classList.remove('hidden');
            }
            document.getElementById('logout-btn').classList.remove('hidden');
            document.getElementById('order-history-btn').classList.remove('hidden');
            document.getElementById('main-header').classList.remove('hidden');
        }

        UI.buttons.googleSignIn.addEventListener('click', async () => {
            try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (e) { console.error(e); alert('Login failed'); }
        });
        UI.buttons.logout.addEventListener('click', async () => {
            await signOut(auth);
        });
        UI.buttons.student.addEventListener('click', () => {
            state.currentRole = 'student'; localStorage.setItem('userRole', 'student'); updateViewBasedOnRole(); startApp();
        });
        UI.buttons.deliverer.addEventListener('click', () => {
            state.currentRole = 'deliverer'; localStorage.setItem('userRole', 'deliverer'); updateViewBasedOnRole(); startApp();
        });

        function startApp() {
            UI.modals.role.classList.add('hidden');
            UI.views.app.classList.remove('hidden');
            renderCafes();
            fetchRequests();
        }

        // --- 6. CAFE RENDER LOGIC ---
        function renderCafes() {
            const container = document.getElementById('cafe-grid-container');
            container.innerHTML = '';
            for (const cafeId in CAFE_DATA) {
                const cafe = CAFE_DATA[cafeId];
                const box = document.createElement('div');
                box.className = 'cafe-box';
                box.dataset.cafeId = cafeId;
                
                // Check if image exists, otherwise use text placeholder
                const mediaHtml = cafe.image 
                    ? `<img src="${cafe.image}" alt="${cafe.name}">`
                    : `<span class="cafe-box-media-text">${cafe.name}</span>`;

                box.innerHTML = `
                    <div class="cafe-box-media">${mediaHtml}</div>
                    <div class="cafe-box-name">${cafe.name}</div>
                `;
                box.addEventListener('click', () => openMenu(cafeId));
                container.appendChild(box);
            }
        }

        function openMenu(cafeId) {
            state.currentOpenCafeId = cafeId;
            const cafe = CAFE_DATA[cafeId];
            document.getElementById('menu-modal-title').textContent = cafe.name;
            const container = document.getElementById('menu-items-container');
            container.innerHTML = '';
            
            cafe.items.forEach(item => {
                const qty = state.cart[item.id]?.quantity || 0;
                const div = document.createElement('div');
                div.className = 'menu-item';
                div.innerHTML = `
                    <div><p class="font-semibold">${item.name}</p><p class="text-sm text-secondary">₹${item.price}</p></div>
                    <div class="flex items-center gap-2">
                        <button class="btn-round-qty btn-secondary" onclick="updateCart('${item.id}', -1)">-</button>
                        <span class="font-bold w-6 text-center">${qty}</span>
                        <button class="btn-round-qty btn-accent" onclick="updateCart('${item.id}', 1)">+</button>
                    </div>
                `;
                // Add event listeners manually to avoid inline onclick issues with modules
                div.querySelectorAll('button')[0].addEventListener('click', () => updateCart(item.id, -1));
                div.querySelectorAll('button')[1].addEventListener('click', () => updateCart(item.id, 1));
                container.appendChild(div);
            });
            toggleModal(UI.modals.menu, true);
        }

        function updateCart(itemId, change) {
            const first = Object.values(state.cart)[0];
            if (first && first.cafeId !== state.currentOpenCafeId) {
                if (!confirm("Clear cart to add items from a different cafe?")) return;
                state.cart = {};
            }
            
            const cafe = CAFE_DATA[state.currentOpenCafeId];
            const item = cafe.items.find(i => i.id === itemId);
            if (!state.cart[itemId]) state.cart[itemId] = { ...item, quantity: 0, cafeId: state.currentOpenCafeId, cafeName: cafe.name };
            
            state.cart[itemId].quantity += change;
            if (state.cart[itemId].quantity <= 0) delete state.cart[itemId];
            
            openMenu(state.currentOpenCafeId); // Re-render menu to show qty
            updateCartUI();
        }

        function updateCartUI() {
            const count = Object.values(state.cart).reduce((a, b) => a + b.quantity, 0);
            const btn = document.getElementById('cart-button');
            if (count > 0 && state.currentRole === 'student') {
                document.getElementById('cart-button-text').textContent = `View Cart (${count})`;
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        }

        // --- 7. CART & CHECKOUT ---
        document.getElementById('cart-button').addEventListener('click', () => {
            const container = document.getElementById('cart-items-container');
            container.innerHTML = '';
            let total = 0;
            if (Object.keys(state.cart).length === 0) container.innerHTML = '<p class="text-center">Empty</p>';
            
            for (const id in state.cart) {
                const item = state.cart[id];
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `<div><p class="font-bold">${item.name} x${item.quantity}</p></div><p>₹${item.price * item.quantity}</p>`;
                container.appendChild(div);
                total += item.price * item.quantity;
            }
            document.getElementById('cart-total-price').textContent = `₹${total}`;
            toggleModal(UI.modals.cart, true);
        });

        document.getElementById('checkout-btn').addEventListener('click', () => {
            toggleModal(UI.modals.cart, false);
            const total = Object.values(state.cart).reduce((a, b) => a + (b.price * b.quantity), 0);
            document.getElementById('checkout-total-display').textContent = `₹${total + APP_CONFIG.deliveryFee}`;
            toggleModal(UI.modals.checkout, true);
        });

        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            UI.modals.loading.classList.remove('hidden');
            
            const block = document.getElementById('block-select').value;
            const room = document.getElementById('room-input').value;
            const itemTotal = Object.values(state.cart).reduce((a, b) => a + (b.price * b.quantity), 0);
            const first = Object.values(state.cart)[0];

            try {
                await addDoc(collection(db, `/artifacts/${APP_CONFIG.firebase.appId}/public/data/deliveries`), {
                    items: Object.values(state.cart),
                    itemPrice: itemTotal,
                    deliveryFee: APP_CONFIG.deliveryFee,
                    totalAmount: itemTotal + APP_CONFIG.deliveryFee,
                    pickupLocation: first.cafeName,
                    dropoffLocation: `${block} - ${room}`,
                    status: 'open',
                    requesterId: state.currentUser.uid,
                    requesterName: state.userDetails.name,
                    requesterPhotoURL: state.userDetails.photoURL,
                    createdAt: serverTimestamp(),
                    subStatus: null, estimatedTime: null
                });
                state.cart = {}; updateCartUI(); UI.modals.loading.classList.add('hidden'); toggleModal(UI.modals.checkout, false); btn.disabled = false;
            } catch (err) { console.error(err); UI.modals.loading.classList.add('hidden'); btn.disabled = false; }
        });

        // --- 8. REALTIME REQUESTS ---
        function fetchRequests() {
            if (state.unsubscribe) state.unsubscribe();
            document.getElementById('loader').classList.remove('hidden');
            const q = query(collection(db, `/artifacts/${APP_CONFIG.firebase.appId}/public/data/deliveries`));
            
            state.unsubscribe = onSnapshot(q, (snap) => {
                document.getElementById('loader').classList.add('hidden');
                const now = Date.now() / 1000;
                let active = [], history = [];
                let deliveryCount = 0;

                snap.forEach(d => {
                    const r = { id: d.id, ...d.data() };
                    if (r.delivererId === state.currentUser.uid && r.status === 'completed') deliveryCount++;
                    history.push(r);
                    
                    // Auto-delete expired open requests
                    if (r.status === 'open' && r.createdAt && (now - r.createdAt.seconds > APP_CONFIG.orderExpirySeconds)) {
                        if (r.requesterId === state.currentUser.uid) deleteDoc(d.ref);
                    } else {
                        active.push(r);
                    }
                });
                
                if (state.currentRole === 'deliverer') document.getElementById('delivery-stats').textContent = `Deliveries: ${deliveryCount}`;
                active.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                renderLists(active);
                renderHistory(history);
            });
        }

        function renderLists(reqs) {
            const myReqs = reqs.filter(r => r.requesterId === state.currentUser.uid);
            const myActive = myReqs.filter(r => r.status !== 'completed');
            
            // Student: Active
            const sList = document.getElementById('my-requests-list');
            sList.innerHTML = myActive.length ? '' : '<p class="text-secondary">No active orders.</p>';
            myActive.forEach(r => sList.appendChild(createCard(r, 'student')));

            // Student: Bar
            const inProg = myReqs.find(r => r.status === 'in-progress');
            const bar = document.getElementById('active-order-bar');
            if (inProg) {
                document.getElementById('active-order-bar-status').textContent = inProg.subStatus || 'In Progress';
                bar.classList.remove('hidden');
            } else bar.classList.add('hidden');

            // Deliverer
            const dMyList = document.getElementById('my-current-deliveries-list');
            const dAllList = document.getElementById('all-requests-list-deliverer');
            const myJobs = reqs.filter(r => r.delivererId === state.currentUser.uid && r.status === 'in-progress');
            const openJobs = reqs.filter(r => r.status === 'open');

            dMyList.innerHTML = myJobs.length ? '' : '<p class="text-secondary">No current jobs.</p>';
            myJobs.forEach(r => dMyList.appendChild(createCard(r, 'deliverer-active')));

            if (myJobs.length > 0) {
                document.getElementById('available-deliveries-container').classList.add('hidden');
                document.getElementById('single-delivery-message').classList.remove('hidden');
            } else {
                document.getElementById('available-deliveries-container').classList.remove('hidden');
                document.getElementById('single-delivery-message').classList.add('hidden');
                dAllList.innerHTML = openJobs.length ? '' : '<p class="text-secondary">No new orders.</p>';
                openJobs.forEach(r => dAllList.appendChild(createCard(r, 'deliverer-open')));
            }
        }

        function createCard(r, view) {
            const div = document.createElement('div');
            div.className = 'card-panel';
            const itemsHtml = r.items ? r.items.map(i => `${i.name} x${i.quantity}`).join(', ') : 'Items';
            const statusBadge = `<span class="badge badge-${r.status}">${r.status}</span>`;
            
            let action = '';
            if (view === 'student' && r.status === 'open') {
                action = `<button class="btn btn-danger btn-sm w-full mt-2" onclick="handleAction('${r.id}', 'cancel')">Cancel</button>`;
            } else if (view === 'deliverer-open') {
                if (r.requesterId !== state.currentUser.uid) 
                    action = `<button class="btn btn-deliverer btn-sm w-full mt-2" onclick="handleAction('${r.id}', 'accept')">Accept (₹${r.deliveryFee})</button>`;
                else action = `<p class="text-sm text-center italic">Your order</p>`;
            } else if (view === 'deliverer-active') {
                if (!r.estimatedTime) action = `<div class="flex gap-2 mt-2"><input id="eta-${r.id}" class="form-input text-xs" placeholder="Mins" type="number"><button class="btn btn-accent btn-sm" onclick="handleAction('${r.id}', 'eta')">Set ETA</button></div>`;
                else if (!r.subStatus) action = `<button class="btn btn-accent btn-sm w-full mt-2" onclick="handleAction('${r.id}', 'reached')">Reached Cafe</button>`;
                else if (r.subStatus === 'reached-cafe') action = `<button class="btn btn-accent btn-sm w-full mt-2" onclick="handleAction('${r.id}', 'picked')">Picked Up</button>`;
                else action = `<button class="btn btn-sm w-full mt-2" style="background:var(--info-bg);color:white" onclick="handleAction('${r.id}', 'done')">Delivered</button>`;
                if (r.estimatedTime) action = `<p class="text-xs text-green-600 font-bold">ETA: ${r.estimatedTime}m</p>` + action;
            }

            div.innerHTML = `
                <div class="flex justify-between mb-2"><div><span class="font-bold text-accent">${itemsHtml}</span></div>${statusBadge}</div>
                <p class="text-sm">From: ${r.pickupLocation} &rarr; To: ${r.dropoffLocation}</p>
                <div class="flex justify-between items-end mt-2">
                    <div><p class="text-xs text-muted">Total: ₹${r.totalAmount}</p></div>
                    <div style="min-width:100px">${action}</div>
                </div>
            `;
            // Attach event listener for buttons since inline JS module scope issue
            div.querySelectorAll('button').forEach(b => {
                const fn = b.getAttribute('onclick');
                if(fn) {
                    b.removeAttribute('onclick');
                    if(fn.includes("'cancel'")) b.addEventListener('click', () => doAction(r.id, 'cancel'));
                    if(fn.includes("'accept'")) b.addEventListener('click', () => doAction(r.id, 'accept'));
                    if(fn.includes("'eta'")) b.addEventListener('click', () => doAction(r.id, 'eta'));
                    if(fn.includes("'reached'")) b.addEventListener('click', () => doAction(r.id, 'reached'));
                    if(fn.includes("'picked'")) b.addEventListener('click', () => doAction(r.id, 'picked'));
                    if(fn.includes("'done'")) b.addEventListener('click', () => doAction(r.id, 'done'));
                }
            });
            return div;
        }

        async function doAction(id, type) {
            const ref = doc(db, `/artifacts/${APP_CONFIG.firebase.appId}/public/data/deliveries`, id);
            if (type === 'cancel') await deleteDoc(ref);
            if (type === 'accept') await updateDoc(ref, { status: 'in-progress', delivererId: state.currentUser.uid, delivererName: state.userDetails.name });
            if (type === 'reached') await updateDoc(ref, { subStatus: 'reached-cafe' });
            if (type === 'picked') await updateDoc(ref, { subStatus: 'picked-up' });
            if (type === 'done') await updateDoc(ref, { status: 'completed' });
            if (type === 'eta') {
                const val = document.getElementById(`eta-${id}`).value;
                if(val) await updateDoc(ref, { estimatedTime: val });
            }
        }

        // --- 9. HELPERS ---
        function toggleModal(el, show) {
            if (show) { el.classList.remove('hidden'); setTimeout(() => el.classList.remove('opacity-0'), 10); }
            else { el.classList.add('opacity-0'); setTimeout(() => el.classList.add('hidden'), 300); }
        }
        function renderHistory(list) {
            const c = document.getElementById('history-items-container');
            c.innerHTML = '';
            const rel = list.filter(r => r.status === 'completed' && (state.currentRole==='student' ? r.requesterId===state.currentUser.uid : r.delivererId===state.currentUser.uid));
            rel.sort((a,b) => b.createdAt.seconds - a.createdAt.seconds);
            if(!rel.length) c.innerHTML='<p class="text-center">No history.</p>';
            rel.forEach(r => {
                const d = document.createElement('div');
                d.className='card-panel';
                d.innerHTML=`<p class="font-bold">${r.items.map(i=>i.name).join(', ')}</p><p class="text-sm">Total: ₹${r.totalAmount}</p><p class="text-xs text-muted">${new Date(r.createdAt.seconds*1000).toLocaleDateString()}</p>`;
                c.appendChild(d);
            });
        }
        
        document.getElementById('menu-close-btn').addEventListener('click', () => toggleModal(UI.modals.menu, false));
        document.getElementById('cart-close-btn').addEventListener('click', () => toggleModal(UI.modals.cart, false));
        document.getElementById('checkout-cancel-btn').addEventListener('click', () => toggleModal(UI.modals.checkout, false));
        document.getElementById('order-history-btn').addEventListener('click', () => { renderHistory([]); toggleModal(UI.modals.history, true); }); // Re-render happens in snapshot
        document.getElementById('history-close-btn').addEventListener('click', () => toggleModal(UI.modals.history, false));
    </script>
</body>
</html>
